---
import { Image } from 'astro:assets';

interface Props {
  src: string;
  poster: ImageMetadata | string;
  title: string;
  description: string;
  label?: string
  uploadDate?: string;
  caption?: string;
  aspectRatio?: string;
}

const { 
  src, 
  poster, 
  title, 
  description, 
  label,
  uploadDate = "2024-01-01", 
  caption,
  aspectRatio = "16/9" 
} = Astro.props;

const jsonLd = {
  "@context": "https://schema.org",
  "@type": "VideoObject",
  "name": title,
  "description": description,
  "thumbnailUrl": [typeof poster === 'string' ? poster : poster.src],
  "uploadDate": uploadDate,
  "contentUrl": src,
};
---

<script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />

<figure class="video-container my-12 w-full group/video">
  <div aria-hidden="true" class="border-t border-black pt-1 mb-2 text-[9px] uppercase tracking-widest text-brand-black/50 font-mono">
    {label || "Source_01"}
  </div>
  
  <div class="relative bg-neutral-100 overflow-hidden" style={`aspect-ratio: ${aspectRatio};`}>
    
    {typeof poster === 'string' ? (
      <img src={poster} alt={title} class="video-poster absolute inset-0 w-full h-full object-cover z-10" />
    ) : (
      <Image 
        src={poster} 
        alt={title} 
        width={1920}
        quality="high"
        class="video-poster absolute inset-0 w-full h-full object-cover z-10 transition-opacity duration-500" 
      />
    )}

    <div class="absolute inset-0 flex items-center justify-center z-0">
      <div class="w-5 h-5 border-2 border-black/5 border-t-black animate-spin rounded-full"></div>
    </div>

    <video
      class="optimized-video absolute inset-0 w-full h-full opacity-0 z-20 transition-opacity duration-700 cursor-pointer"
      data-src={src}
      preload="none"
      loop
      playsinline
    ></video>

    <button 
      class="unmute-button absolute bottom-4 right-4 z-30 bg-black/80 text-white px-3 py-1.5 text-[8px] uppercase tracking-widest font-mono opacity-0 group-hover/video:opacity-100 transition-opacity"
    >
      Unmute
    </button>
  </div>

  {caption && (
    <figcaption class="mt-4 font-mono text-[10px] uppercase tracking-widest text-black/40">
      {caption}
    </figcaption>
  )}
</figure>

<script>
  function initOptimizedVideo(container: HTMLElement) {
    const video = container.querySelector('.optimized-video') as HTMLVideoElement;
    const poster = container.querySelector('.video-poster') as HTMLElement;
    const unmuteBtn = container.querySelector('.unmute-button') as HTMLButtonElement;
    
    if (!video || !video.dataset.src) return;

    // Start muted so autoplay works
    video.muted = true;

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          if (!video.src) {
            video.src = video.dataset.src!;
            video.load();
          }
          video.play().catch(() => {});
        } else {
          video.pause();
        }
      });
    }, { threshold: 0.1 });

    observer.observe(video);

    video.addEventListener('playing', () => {
      video.classList.remove('opacity-0');
      poster.classList.add('opacity-0');
    });

    // Toggle Audio
    unmuteBtn?.addEventListener('click', (e) => {
      e.stopPropagation(); // Prevent play/pause toggle
      video.muted = !video.muted;
      unmuteBtn.textContent = video.muted ? 'Unmute' : 'Mute';
    });

    // Toggle Play/Pause
    video.addEventListener('click', () => {
      if (video.paused) {
        video.play();
      } else {
        video.pause();
      }
    });
  }

  function run() {
    document.querySelectorAll('.video-container').forEach(v => initOptimizedVideo(v as HTMLElement));
  }

  run();
  document.addEventListener('astro:after-swap', run);
</script>