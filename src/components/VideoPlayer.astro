---
import { CDN_URL } from '../lib/constant';

// VideoWrapper.astro
interface Props {
  src: string;             // Cloudflare R2 Video URL
  poster: string;          // Cloudflare R2 Image URL
  title: string;
  description: string;
  label?: string
  uploadDate?: string;
  caption?: string;
  aspectRatio?: string;
}

const { 
  src, 
  poster, 
  title, 
  description, 
  label,
  uploadDate = "2024-01-01", 
  caption,
  aspectRatio = "16/9" 
} = Astro.props;

// Schema.org metadata for Video SEO
const jsonLd = {
  "@context": "https://schema.org",
  "@type": "VideoObject",
  "name": title,
  "description": description,
  "thumbnailUrl": [poster], // Now always a string
  "uploadDate": uploadDate,
  "contentUrl": src,
};

const realSrc = `${CDN_URL}${src}`
const realPoster = `${CDN_URL}${poster}?w=1024&q=80`
---

<script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />

<figure class="video-container my-12 w-full group/video">
  <div aria-hidden="true" class="border-t border-black pt-1 mb-2 text-[9px] uppercase tracking-widest text-brand-black/50 font-mono">
    {label || "Source_01"}
  </div>
  
  <div class="relative bg-neutral-100 overflow-hidden" style={`aspect-ratio: ${aspectRatio};`}>
    
    <img 
      src={realPoster} 
      alt={title} 
      loading="lazy"
      decoding="async"
      class="video-poster absolute inset-0 w-full h-full object-cover z-10 transition-opacity duration-500" 
    />

    <div class="absolute inset-0 flex items-center justify-center z-0">
      <div class="w-5 h-5 border-2 border-black/5 border-t-black animate-spin rounded-full"></div>
    </div>

    <video
      class="optimized-video absolute inset-0 w-full h-full opacity-0 z-20 transition-opacity duration-700 cursor-pointer"
      data-src={realSrc}
      preload="none"
      loop
      muted
      playsinline
    ></video>

    <button 
      class="unmute-button absolute bottom-4 right-4 z-30 bg-black/80 text-white px-3 py-1.5 text-[8px] uppercase tracking-widest font-mono opacity-0 group-hover/video:opacity-100 transition-opacity"
    >
      Unmute
    </button>
  </div>

  {caption && (
    <figcaption class="mt-4 font-mono text-[10px] uppercase tracking-widest text-black/40">
      {caption}
    </figcaption>
  )}
</figure>

<script>
  function initOptimizedVideo(container: HTMLElement) {
    const video = container.querySelector('.optimized-video') as HTMLVideoElement;
    const poster = container.querySelector('.video-poster') as HTMLElement;
    const unmuteBtn = container.querySelector('.unmute-button') as HTMLButtonElement;
    
    if (!video || !video.dataset.src) return;

    // Intersection Observer for Autoplay/Pause
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          if (!video.src) {
            video.src = video.dataset.src!;
            video.load();
          }
          video.play().catch(() => {});
        } else {
          video.pause();
        }
      });
    }, { threshold: 0.1 });

    observer.observe(video);

    // Cross-fade poster to video once playing
    video.addEventListener('playing', () => {
      video.classList.remove('opacity-0');
      poster.classList.add('opacity-0');
    });

    unmuteBtn?.addEventListener('click', (e) => {
      e.stopPropagation();
      video.muted = !video.muted;
      unmuteBtn.textContent = video.muted ? 'Unmute' : 'Mute';
    });

    video.addEventListener('click', () => {
      video.paused ? video.play() : video.pause();
    });
  }

  function run() {
    document.querySelectorAll('.video-container').forEach(v => initOptimizedVideo(v as HTMLElement));
  }

  // Handle both initial load and Astro View Transitions
  run();
  document.addEventListener('astro:after-swap', run);
</script>