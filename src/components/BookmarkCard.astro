---
import ogs from 'open-graph-scraper-lite';

interface Props {
  url: string;
}

const { url } = Astro.props;

// Fetch the metadata during build time
let metadata = { title: url, description: '', image: '' };

try {
  const response = await fetch(url);
  const html = await response.text();
  const { result } = await ogs({ html });
  
  metadata = {
    title: result.ogTitle || "Link Preview",
    description: result.ogDescription || url,
    image: result.ogImage?.[0]?.url || ""
  };
} catch (e) {
  console.error(`Failed to fetch metadata for ${url}`);
}
---

<a href={url} target="_blank" class="group block my-8 border border-black/10 hover:border-black transition-all bg-white overflow-hidden no-underline">
  <div class="flex flex-col md:flex-row min-h-[140px]">
    
    <div class="flex-1 p-5 flex flex-col justify-center">
      <div class="font-mono text-[9px] uppercase tracking-widest text-black/30 mb-2 flex items-center gap-2">
        <img src={`https://www.google.com/s2/favicons?domain=${url}&sz=32`} class="w-3 h-3 grayscale opacity-50" />
        {new URL(url).hostname}
      </div>
      
      <h4 class="text-base font-bold text-black group-hover:text-brand-black mb-1 line-clamp-1">
        {metadata.title}
      </h4>
      
      <p class="text-[11px] text-black/50 leading-relaxed line-clamp-2 italic">
        {metadata.description}
      </p>
    </div>

    {metadata.image && (
      <div class="md:w-52 w-full h-32 md:h-auto overflow-hidden border-t md:border-t-0 md:border-l border-black/5 bg-neutral-50">
        <img 
          src={metadata.image} 
          alt={metadata.title}
          class="w-full h-full object-cover grayscale group-hover:grayscale-0 transition-all duration-700"
        />
      </div>
    )}
  </div>
</a>