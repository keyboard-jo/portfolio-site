---
import '../styles/global.css';
import SwissGrid from '../components/SwissGrid.astro';
import { ClientRouter } from 'astro:transitions';

interface Props {
    title?: string;
    pageId?: string; 
}
const { title = "Happy Media Strategy", pageId = "default" } = Astro.props;
---

<!doctype html>
<html lang="en">
    <head>
        <ClientRouter />
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width" />
        <link rel="icon" href="/favicon.svg">
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Space+Mono:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
        <title>{title}</title>
    </head>
    <body data-page-id={pageId}>
        <slot />
        <SwissGrid />

        <script>
            import * as THREE from 'three';
            import { gsap } from 'gsap';
            import { ScrollTrigger } from 'gsap/ScrollTrigger';
            import Lenis from 'lenis';
            import PhotoSwipeLightbox from 'photoswipe/lightbox';
            import 'photoswipe/style.css';

            gsap.registerPlugin(ScrollTrigger);

            // --- GLOBAL PERSISTENT INSTANCES ---
            let lenis;
            let renderer, scene, camera, sphere, animationId;
            let lightbox;

            // 1. Initialize Lenis ONCE (outside the main init to keep it persistent)
            function setupLenis() {
                if (lenis) lenis.destroy();
                lenis = new Lenis({
                duration: 1.2,
                lerp: 0.08,
                smoothWheel: true,
                });

                lenis.on('scroll', ScrollTrigger.update);
                gsap.ticker.add((time) => {
                lenis.raf(time * 1000);
                });
                gsap.ticker.lagSmoothing(0);
            }

            // 2. The Main Router / Init function
            function init() {
                console.log("ðŸš€ Route Change: Initializing Engine");

                const pageId = document.body.getAttribute('data-page-id');

                console.log(`ðŸš€ Current Page ID: ${pageId}`);

                // --- A. CLEANUP ---
                ScrollTrigger.getAll().forEach(t => t.kill());
                if (animationId) cancelAnimationFrame(animationId);
                if (lenis) lenis.scrollTo(0, { immediate: true });

                // --- B. EXTERNAL LINKS HANDLER ---
                document.querySelectorAll('a[href^="http"]').forEach(link => {
                link.setAttribute('target', '_blank');
                link.setAttribute('rel', 'noopener noreferrer');
                });

                initPhotoSwipe();

                // --- C. PAGE ROUTING ---
                switch (pageId) {
                case 'index':
                    runIndexAnimations();
                    initThreeJS();
                    break;
                case 'posts':
                    runPostAnimations();
                    break;
                case 'about':
                    runAboutAnimations();
                    break;
                }

                // Always reveal header if hidden
                gsap.to(".site-header", { autoAlpha: 1, duration: 1 });
                
                ScrollTrigger.refresh();
            }

            // --- PAGE: INDEX LOGIC ---
            function runIndexAnimations() {
                const heroTl = gsap.timeline({ defaults: { ease: "expo.out" } });
                heroTl.set(".hero-section .reveal-text, .hero-section .list-item", { y: "105%", autoAlpha: 1 });
                heroTl.to(".hero-section .reveal-text", { y: "0%", duration: 1.2, stagger: 0.1 })
                    .to(".hero-section .list-item", { y: "0%", duration: 1, stagger: 0.1 }, "-=0.8");

                const feedDisplay = document.querySelector('.feed-id-display');
                const finalValue = feedDisplay?.getAttribute('data-final-id');
                if (feedDisplay) {
                gsap.to({}, {
                    scrollTrigger: { trigger: ".feed-container", start: "top 90%" },
                    duration: 1.5,
                    onUpdate: () => {
                    const rand = () => Math.random().toString(36).substring(2, 5).toUpperCase();
                    feedDisplay.textContent = `Selected Feed // ${rand()}â€”${rand()}`;
                    },
                    onComplete: () => { if (finalValue) feedDisplay.textContent = `Selected Feed // ${finalValue}`; }
                });
                }

                document.querySelectorAll('.post-entry').forEach((entry) => {
                const revealItems = entry.querySelectorAll('.reveal-item');
                const entryImg = entry.querySelector('.reveal-img');
                const entryTl = gsap.timeline({ scrollTrigger: { trigger: entry, start: "top 90%" } });
                entryTl.set(revealItems, { y: "110%", autoAlpha: 0 })
                        .to(revealItems, { autoAlpha: 1, y: "0%", duration: 0.8, stagger: 0.05 });
                if (entryImg) {
                    entryTl.fromTo(entryImg, 
                        { autoAlpha: 0, scale: 1.4 }, 
                        { 
                            autoAlpha: 1, 
                            scale: 1, 
                            duration: 1.6, 
                            clearProps: "transform",
                            // Add the class when this specific animation finishes
                            onComplete: () => entryImg.classList.add('is-ready')
                        }, 
                        "-=0.8"
                    );
                }
                });
            }

            // --- PAGE: POST LOGIC ---
            function runPostAnimations() {
                const tl = gsap.timeline({ defaults: { ease: "expo.out" } });
                tl.set(".page-reveal-item", { y: "110%", autoAlpha: 1 })
                .to(".page-reveal-item", { y: "0%", duration: 1.2, stagger: 0.1 })
                .fromTo(".page-hero-img", { autoAlpha: 0, scale: 1.4 }, { autoAlpha: 1, scale: 1, duration: 2, clearProps: "transform" }, "-=1");
            }

            // --- PAGE: ABOUT LOGIC ---
            function runAboutAnimations() {
                const tl = gsap.timeline({ defaults: { ease: "expo.out" } });
                tl.set(".page-reveal-item", { y: "110%", autoAlpha: 1 })
                .set(".reveal-item", { autoAlpha: 0, y: 20 })
                .set(".about-border", { scaleX: 0, transformOrigin: "left" })
                .to(".page-reveal-item", { y: "0%", duration: 1.5, stagger: 0.1 })
                .to(".reveal-item", { autoAlpha: 1, y: 0, duration: 1, stagger: 0.1 }, "-=1")
                .to(".about-border", { scaleX: 1, duration: 1.5, ease: "expo.inOut" }, "-=1.2");
            }

            // --- THREE.JS ENGINE ---
            function initThreeJS() {
                const container = document.getElementById('canvas-container');
                if (!container) return;

                const scene = new THREE.Scene();
                const camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 1000);
                camera.position.set(-30, 15, 30);
                camera.lookAt(-18, -5, 0);

                const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); // Limit pixel ratio for performance
                renderer.setSize(container.clientWidth, container.clientHeight);
                container.appendChild(renderer.domElement);

                // --- OPTIMIZED PARTICLE SETUP ---
                const width = 180; 
                const depth = 80;
                const spacing = 0.5;
                const numParticles = width * depth;

                const geometry = new THREE.BufferGeometry();
                const positions = new Float32Array(numParticles * 3);

                let i = 0;
                for (let x = 0; x < width; x++) {
                    for (let z = 0; z < depth; z++) {
                        positions[i]     = (x - width / 2) * spacing; 
                        positions[i + 1] = 0;                         
                        positions[i + 2] = (z - depth / 2) * spacing; 
                        i += 3;
                    }
                }

                geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));

                // --- THE SHADER MATERIAL (The Speed Boost) ---
                // We define the math once here. The GPU runs this in parallel.
                const material = new THREE.ShaderMaterial({
                    uniforms: {
                        uTime: { value: 0 },
                        uColor: { value: new THREE.Color(0xFF3E00) },
                        uPointSize: { value: 0.2 * (window.innerHeight / 2) } // Adjust size for screen height
                    },
                    vertexShader: `
                        uniform float uTime;
                        uniform float uPointSize;
                        void main() {
                            vec3 pos = position;

                            // Our Chaotic Math moved to GLSL (Runs on GPU)
                            float dynamicFreq = sin(uTime * 0.5) * 0.05 + 0.1;
                            float dynamicSpeed = uTime + cos(uTime * 0.3) * 2.0;

                            float wave1 = sin(pos.x * dynamicFreq + dynamicSpeed);
                            float wave2 = sin(pos.z * 0.2 + uTime * 1.5);
                            
                            pos.y = (wave1 + wave2) * 2.5;

                            vec4 mvPosition = modelViewMatrix * vec4(pos, 1.0);
                            gl_PointSize = uPointSize * (1.0 / -mvPosition.z); // Size Attenuation
                            gl_Position = projectionMatrix * mvPosition;
                        }
                    `,
                    fragmentShader: `
                        uniform vec3 uColor;
                        void main() {
                            // Makes the particles round instead of square
                            if (length(gl_PointCoord - vec2(0.5)) > 0.5) discard;
                            gl_FragColor = vec4(uColor, 0.6);
                        }
                    `,
                    transparent: true,
                    depthWrite: false, // Helps with transparency blending performance
                });

                const particleSheet = new THREE.Points(geometry, material);
                scene.add(particleSheet);

                function animate() {
                    requestAnimationFrame(animate);
                    
                    // Update ONLY the time. No big loops here!
                    material.uniforms.uTime.value = performance.now() * 0.0015;
                    
                    renderer.render(scene, camera);
                }

                animate();
            }

            // --- PHOTOSWIPE LOGIC ---
            function initPhotoSwipe() {
                if (lightbox) lightbox.destroy();
                lightbox = new PhotoSwipeLightbox({
                gallery: '.pswp-gallery',
                children: 'a',
                pswpModule: () => import('photoswipe')
                });
                lightbox.init();
            }

            // --- LIFECYCLE LISTENERS ---
            
            // Initial setup for Lenis
            setupLenis();

            // Handle first load and page swaps
            document.addEventListener('astro:page-load', init);

            // Resize handler
            window.addEventListener('resize', () => {
                const container = document.getElementById('canvas-container');
                if (renderer && camera && container) {
                camera.aspect = container.clientWidth / container.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(container.clientWidth, container.clientHeight);
                }
            });
            </script>
    </body>
</html>

<style>
	html,
	body {
		margin: 0;
		width: 100%;
		height: 100%;
	}
</style>
<noscript>
    <style>
        .site-header,
        .reveal-text, 
        .list-item, 
        .reveal-item, 
        .page-reveal-item,
        .reveal-img, 
        .page-hero-img,
        {
            opacity: 1 !important;
            visibility: visible !important;
            transform: none !important;
        }
    </style>
</noscript>
